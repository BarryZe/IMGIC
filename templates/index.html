<!DOCTYPE html>
<html lang="en">

<head>
   <meta charset="UTF-8">
   <meta http-equiv="X-UA-Compatible" content="IE=edge">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>IMGIC</title>
   <link rel="stylesheet" href="{{url_for('static',filename='dist/css/output.css')}}">
   <link rel="shortcut icon" href="{{ url_for('static', filename='assets/favicon.ico') }}">
</head>

<body>

   <!-- NAV BAR -->

   <nav class="fixed top-0 z-50 w-full bg-white border-b border-gray-200 dark:bg-gray-800 dark:border-gray-700">
      <div class="px-3 py-3 lg:px-5 lg:pl-3">
         <div class="flex items-center justify-between">
            <div class="flex items-center justify-start rtl:justify-end">
               <button data-drawer-target="logo-sidebar" data-drawer-toggle="logo-sidebar" aria-controls="logo-sidebar"
                  type="button"
                  class="inline-flex items-center p-2 text-sm text-gray-500 rounded-lg sm:hidden hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-600">
                  <span class="sr-only">Open sidebar</span>
                  <svg class="w-6 h-6" aria-hidden="true" fill="currentColor" viewBox="0 0 20 20"
                     xmlns="http://www.w3.org/2000/svg">
                     <path clip-rule="evenodd" fill-rule="evenodd"
                        d="M2 4.75A.75.75 0 012.75 4h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 4.75zm0 10.5a.75.75 0 01.75-.75h7.5a.75.75 0 010 1.5h-7.5a.75.75 0 01-.75-.75zM2 10a.75.75 0 01.75-.75h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 10z">
                     </path>
                  </svg>
               </button>
               <div class="flex ms-2 md:me-24">
                  <img src="static/assets/imgic-logo.png" class="h-8 me-3" alt="IMGIC Logo" />
                  <span
                     class="self-center text-xl font-semibold sm:text-2xl whitespace-nowrap dark:text-white">IMGIC</span>
               </div>
            </div>
            <div class="flex items-center">
               <div class="flex items-center ms-3">
                  <div>
                     <button type="button"
                        class="flex text-sm bg-gray-800 rounded-full focus:ring-4 focus:ring-gray-300 dark:focus:ring-gray-600"
                        aria-expanded="false" data-dropdown-toggle="dropdown-user">
                        <span class="sr-only">Open user menu</span>
                        <img class="w-8 h-8 rounded-full" src="../static/assets/codejam-logo.png" alt="user photo">
                     </button>
                  </div>
                  <div
                     class="z-50 hidden my-4 text-base list-none bg-white divide-y divide-gray-100 rounded shadow dark:bg-gray-700 dark:divide-gray-600"
                     id="dropdown-user">
                     <div class="px-4 py-3" role="none">
                        <p class="text-sm text-gray-900 dark:text-white" role="none">
                           Ctrl + Z Warriors
                        </p>
                        <p class="text-sm font-medium text-gray-900 truncate dark:text-gray-300" role="none">
                           CodeJam 13
                        </p>
                     </div>
                     <ul class="py-1" role="none">
                        <li>
                           <a href="#"
                              class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-600 dark:hover:text-white"
                              role="menuitem"> Home </a>
                        </li>
                        <li>
                           <a href="#"
                              class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-600 dark:hover:text-white"
                              role="menuitem">Settings</a>
                        </li>
                        <li>
                           <a href="#"
                              class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-600 dark:hover:text-white"
                              role="menuitem">Sign out</a>
                        </li>
                     </ul>
                  </div>
               </div>
            </div>
         </div>
      </div>
   </nav>

   <!-- SIDE BAR -->

   <aside id="logo-sidebar"
      class="fixed top-0 left-0 z-40 w-64 h-screen pt-20 transition-transform -translate-x-full bg-white border-r border-gray-200 sm:translate-x-0 dark:bg-gray-800 dark:border-gray-700"
      aria-label="Sidebar">
      <div class="h-full px-3 pb-4 overflow-y-auto bg-white dark:bg-gray-800">
         <ul class="space-y-2 font-medium">
            <li>
               <a href="#"
                  class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group">
                  <svg class="w-[22px] h-[22px] text-gray-800 dark:text-white" aria-hidden="true"
                     xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
                     <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 8v10a1 1 0 0 0 1 1h4v-5a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v5h4a1 1 0 0 0 1-1V8M1 10l9-9 9 9" />
                  </svg>
                  <span class="ms-3">Home</span>
               </a>
            </li>
            <li>
               <a href="#" data-modal-target="get-song-modal" data-modal-toggle="get-song-modal"
                  class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group">
                  <svg class="w-[22px] h-[22px] text-gray-800 dark:text-white" aria-hidden="true"
                     xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
                     <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10 5.757v8.486M5.757 10h8.486M19 10a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                  </svg>
                  <span class="flex-1 ms-3 whitespace-nowrap">Get a Song</span>
               </a>
            </li>
         </ul>
      </div>
   </aside>



   <div class="p-4 sm:ml-64">
      <div class="p-4 mt-14">
         <div id="gallery" class="grid grid-cols-4 md:grid-cols-3 gap-4">
            {% for image in init_files %}
            <div class="card-container">
               <div class="gallery-block" onclick="toggle_play('{{ image }}'.split('.')[0])">
                  <img src="static/uploads/{{ image }}">
               </div>
            </div>
            {% endfor %}
         </div>
      </div>
   </div>

   <!-- Create Song Modal -->
   <div id="get-song-modal" tabindex="-1" aria-hidden="true"
      class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
      <div class="relative p-4 w-full max-w-3xl max-h-full">
         <!-- Modal content -->
         <div class="relative bg-white rounded-lg shadow dark:bg-gray-700">
            <!-- Modal header -->
            <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t dark:border-gray-600">
               <h3
                  class="text-center text-xl font-bold leading-none tracking-tight text-gray-900 md:text-3xl lg:text-4xl dark:text-white">
                  Get a Song</h3>
               <button type="button"
                  class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white"
                  data-modal-hide="get-song-modal">
                  <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none"
                     viewBox="0 0 14 14">
                     <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6" />
                  </svg>
                  <span class="sr-only">Close modal</span>
               </button>
            </div>
            <!-- Modal body -->
            <div class="p-4 md:p-5 space-y-4">
               <div class="flex items-center justify-center w-full">
                  <label for="dropzone-file"
                     class="flex flex-col items-center justify-center w-full h-64 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 dark:hover:bg-bray-800 dark:bg-gray-700 hover:bg-gray-100 dark:border-gray-600 dark:hover:border-gray-500 dark:hover:bg-gray-600">
                     <div class="flex flex-col items-center justify-center pt-5 pb-6">
                        <svg class="w-8 h-8 mb-4 text-gray-500 dark:text-gray-400" aria-hidden="true"
                           xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16">
                           <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2" />
                        </svg>
                        <p class="mb-2 text-sm text-gray-500 dark:text-gray-400"><span class="font-semibold">Click to
                              upload</span></p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">SVG, PNG, JPG or GIF</p>
                     </div>
                     <input id="dropzone-file" type="file" class="hidden" oninput="upload_file()"
                        ondrop="dropHandler(event)" ondragover="dragOverHandler(event)" />
                  </label>
               </div>
            </div>
            <!-- Modal footer -->
            <div class="flex items-center p-4 md:p-5 border-t border-gray-200 rounded-b dark:border-gray-600">
               <!-- <input class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 dark:text-gray-400 focus:outline-none dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400" id="file_input" type="file"> -->
               <button data-modal-hide="get-song-modal" data-modal-target="popup-modal" data-modal-toggle="popup-modal"
                  onclick="StartCamera();" type="button"
                  class="ms-3 text-gray-500 bg-white hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-blue-300 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 hover:text-gray-900 focus:z-10 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-500 dark:hover:text-white dark:hover:bg-gray-600 dark:focus:ring-gray-600">Take
                  Photo</button>

            </div>
         </div>
      </div>
   </div>

   <!-- Webcam pop-up -->
   <button data-modal-target="popup-modal" data-modal-toggle="popup-modal"
      class="block text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800"
      type="button">
      Toggle modal
   </button>

   <div id="popup-modal" tabindex="-1"
      class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
      <div class="relative p-4 w-full max-w-3xl max-h-full">
         <div class="relative bg-white rounded-lg shadow dark:bg-gray-700">
            <button type="button"
               class="absolute top-3 end-2.5 text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white"
               data-modal-hide="popup-modal">
               <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none"
                  viewBox="0 0 14 14">
                  <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                     d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6" />
               </svg>
               <span class="sr-only">Close modal</span>
            </button>
            <div class="p-4 md:p-5 text-center">
               <div style="padding: 25px 0px 25px 0px" class="video-container" justify-contents="center"
                  align-items="center" width="100%">
                  <video autoplay="true" id="camera" width="100%" height="240">

                  </video>
                  <canvas id="myCanvas" width="100%" height="240"> </canvas>

               </div>
               <button data-modal-hide="popup-modal" type="button" onclick="freezeFrame();"
                  class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-full text-sm p-2.5 text-center inline-flex items-center me-2 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">
                  <svg class="w-6 h-6 text-gray-800 dark:text-white" aria-hidden="true"
                     xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 18">
                     <path stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10 12.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z" />
                     <path stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17 3h-2l-.447-.894A2 2 0 0 0 12.764 1H7.236a2 2 0 0 0-1.789 1.106L5 3H3a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h16a1 1 0 0 0 1-1V5a2 2 0 0 0-2-2Z" />
                  </svg>
                  <span class="sr-only">Icon description</span>
               </button>

            </div>
         </div>
      </div>
   </div>



   <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.1.1/flowbite.min.js"></script>

   <script>
      var video = document.getElementById("camera");
      var canvas = document.getElementById("myCanvas");
      var camera = false;
      let currentStream = null;
      var capturedImage = false;
      var btnStart = document.getElementById("btnStart");
      var ctx = canvas.getContext('2d');
      var gallery = document.getElementById("gallery");
      var current_playing = null;

      function StartCamera() {

         ctx.clearRect(0, 0, canvas.width, canvas.height);

         canvas.setAttribute("hidden", "hidden");
         canvas.setAttribute("display", "hidden");

         if (!camera) {

            if (navigator.mediaDevices.getUserMedia) {
               navigator.mediaDevices.getUserMedia(
                  {
                     video: true
                  }).then(function (stream) {
                     currentStream = stream;
                     video.srcObject = currentStream;
                     video.style.display = 'block';
                     camera = true;
                     btnStart.value = "Stop Camera";
                  }).catch(function (err) {
                     console.log(err);
                  });
            }
         }
         else {
            camera = false;
            currentStream.getTracks().forEach(track => track.stop());
            video.srcObject = null;
            btnStart.value = "Start Camera";
         }
      }

      function freezeFrame() {
         if (camera && currentStream) {
            const videoTrack = currentStream.getVideoTracks()[0];
            const imageCapture = new ImageCapture(videoTrack)

            imageCapture.grabFrame()
               .then(imageBitmap => {
                  canvas.width = Math.min(imageBitmap.width, imageBitmap.height);
                  canvas.height = Math.min(imageBitmap.width, imageBitmap.height);
                  // canvas.removeAttribute("hidden");
                  ctx.drawImage(
                     imageBitmap,
                     0, 0,              // Position to draw the cropped image on the canvas
                  )
                     ;

                  // Hide the video and show the frozen frame canvas
                  video.style.display = 'none';
                  // canvas.style.display = 'block';
                  revokeCameraPermission();
                  capturedImage = true;

                  // submit image
                  canvas.toBlob(function (blob) {
                     // Create FormData and append the image Blob
                     const formData = new FormData();
                     const filename = Date.now() + ".png"
                     formData.append('file', blob, filename);

                     const requestOptions = {
                        headers: {
                           "Content-Type": "image/png",
                        },
                        mode: "no-cors",
                        method: "POST",
                        files: blob,
                        body: formData,
                     };
                     console.log(requestOptions);

                     FlowbiteInstances.getInstance('Modal', 'get-song-modal').hide();

                     fetch("/upload", requestOptions).then(
                        (response) => {
                           console.log(response.data);
                        }
                     );

                     add_to_gallery("static/uploads/" + filename);
                  }, 'image/png');

               })
               .catch(error => {
                  console.error('Error grabbing frame:', error);
               });
         }
      }

      function revokeCameraPermission() {
         if (currentStream) {
            currentStream.getTracks().forEach(track => track.stop());
            const tracks = currentStream.getTracks();
            tracks.forEach(track => track.stop());
            currentStream = null;
            camera = false;
         }
      }

      function upload_file() {
         const formData = new FormData();
         const input_file = document.getElementById("dropzone-file").files[0];
         formData.append("file", input_file);
         const requestOptions = {
            headers: {
               "Content-Type": input_file.contentType,
            },
            mode: "no-cors",
            method: "POST",
            files: input_file,
            body: formData,
         };
         console.log(requestOptions);

         FlowbiteInstances.getInstance('Modal', 'get-song-modal').hide();

         fetch("/upload", requestOptions).then(
            (response) => {
               console.log(response.data);
            }
         );

         add_to_gallery("static/uploads/" + input_file.name);
      }

      function add_to_gallery(filename) {
         console.log("Adding image from " + filename);
         const node = document.createElement("div");
         node.className = "card-container";
         const node_div = node.appendChild(document.createElement("div"));
         node_div.className = "gallery-block";
         gallery.insertBefore(node, gallery.firstChild);
         const node_img = node_div.appendChild(document.createElement("img"));
         node_img.style.opacity = 0.3;

         setTimeout(() => {
            node_img.src = filename;
            node_img.onclick = function () {
               toggle_play(filename.split("/").pop().split(".")[0]);
            };
         }, 2000);

         var audio_filename = '/static/output/' + filename.split("/").pop().split(".")[0] + '.wav';
         audio_loading(audio_filename, node_div, node_img, 500);
      }

      async function audio_loading(filePath, node_div, node_img, maxAttempts) {
         const delay = 20 * 1000; // 20 sec in milliseconds
         let attempts = 0;

         async function checkFile() {
            attempts++;

            // Make a GET request to the file path
            const response = await fetch(filePath);
            console.log(response);

            // Check if the response status is not 404 (replace this with your actual condition)
            if (response.status !== 404) {
               console.log('File found!');
               node_img.style.opacity = 1;
               // Perform actions with the file, or return a promise if needed
               return Promise.resolve(filePath);
            }

            console.log(`Attempt ${attempts}: File not found yet. Retrying in 20 sec...`);

            // If maxAttempts is reached, reject the promise
            if (attempts >= maxAttempts) {
               return Promise.reject(new Error(`File not found after ${attempts} attempts.`));
            }

            // Schedule the next check after the delay
            await new Promise(resolve => setTimeout(resolve, delay));
            return checkFile();
         }

         // Start the initial delay and file check
         return new Promise(resolve => setTimeout(resolve, delay)).then(checkFile);
      }

      function toggle_play(name) {
         console.log(current_playing);
         var audio_filename = 'static/output/' + name + '.wav';
         if (current_playing != null) {
            current_playing.pause();
            if (current_playing.src.includes(audio_filename)) {
               current_playing = null;
               return;
            };
            current_playing = null;
         }
         try {
            current_playing = new Audio(audio_filename);
            current_playing.play();
         } catch (error) {
            console.log("Audio not available yet");
         }
      }

      function dragOverHandler(event) {
         event.preventDefault();
      }

      function dropHandler(ev) {
         console.log("File(s) dropped");
         ev.preventDefault();

         if (ev.dataTransfer.items) {
            // Use DataTransferItemList interface to access the file(s)
            [...ev.dataTransfer.items].forEach((item, i) => {
               // If dropped items aren't files, reject them
               if (item.kind === "file") {
                  const file = item.getAsFile();
                  console.log(`… file[${i}].name = ${file.name}`);
               }
            });
         } else {
            // Use DataTransfer interface to access the file(s)
            [...ev.dataTransfer.files].forEach((file, i) => {
               console.log(`… file[${i}].name = ${file.name}`);
            });
         }
      }
   </script>

</body>

</body>


<style>
   .gallery-block {
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
   }

   .gallery-block img {
      width: 80%;
   }

   .card-container {
      background-color: white;
      border: 1px;
      border-style: solid;
      border-color: lightgray;
      border-radius: 10px;
      padding: 20px 10px 20px 10px;
   }

   .card-container:hover {
      background-color: rgba(185, 185, 185, 0.2);
   }
</style>

</html>